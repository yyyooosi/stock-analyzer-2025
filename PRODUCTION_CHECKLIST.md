# 本番環境確認チェックリスト

このチェックリストを使って、本番環境でスクリーニングAPIが正常に動作しているか確認してください。

---

## ✅ デプロイ前チェック

### 1. ローカル環境での動作確認

- [ ] `npm install` が正常に完了する
- [ ] `npm run build` が成功する
- [ ] `npm start` で本番モードが起動する
- [ ] `.env.local` に `FMP_API_KEY` が設定されている
- [ ] ローカルで `/screener` ページが表示される

### 2. コードの最終確認

- [ ] すべての変更がコミットされている
- [ ] `main` または `master` ブランチにマージ済み
- [ ] GitHubにプッシュ済み

```bash
git status  # クリーンであることを確認
git log --oneline -5  # 最新のコミットを確認
```

---

## 🚀 デプロイ確認

### 3. ホスティングプラットフォーム

使用しているプラットフォームにチェック:

- [ ] **Vercel** - https://vercel.com/dashboard
- [ ] **Netlify** - https://app.netlify.com/
- [ ] **AWS Amplify**
- [ ] **その他**: _______________

### 4. デプロイ状態

- [ ] プロジェクトがダッシュボードに表示されている
- [ ] 最新のデプロイが成功している（緑のチェックマーク）
- [ ] ビルドログにエラーがない
- [ ] 本番URLが発行されている

**本番URL**: _____________________________ (例: https://stock-analyzer-2025.vercel.app)

### 5. 環境変数の設定

プラットフォームのダッシュボードで確認:

- [ ] `FMP_API_KEY` が設定されている
- [ ] 値が正しい（`f3FJh2JitCLnTYOl9iVSVAe6v9SekGdy`）
- [ ] 環境が `Production` または `All` に設定されている
- [ ] （オプション）`ALPHA_VANTAGE_API_KEY` が設定されている

**確認方法 (Vercel)**:
1. Dashboard → プロジェクトを選択
2. Settings → Environment Variables
3. `FMP_API_KEY` が表示されることを確認

---

## 🔍 API動作確認

### 6. 診断エンドポイントのテスト

#### ブラウザで確認:
```
https://[your-app].vercel.app/api/test-fmp
```

#### curlで確認:
```bash
curl https://[your-app].vercel.app/api/test-fmp
```

#### 期待される結果:

✅ **成功**:
```json
{
  "apiKeyConfigured": true,
  "message": "✅ FMP API is working!",
  "workingEndpoint": "Stock Quote (AAPL,MSFT)",
  "stockCount": 2,
  "sampleStocks": [...]
}
```

- [ ] `apiKeyConfigured: true` が返される
- [ ] `workingEndpoint` が表示される
- [ ] `sampleStocks` にデータが含まれる

❌ **失敗例と対処法**:

**ケース1**: APIキー未設定
```json
{
  "apiKeyConfigured": false,
  "message": "❌ FMP_API_KEY is NOT configured"
}
```
→ **対処**: 環境変数を設定して再デプロイ

**ケース2**: すべてのエンドポイントが失敗
```json
{
  "message": "❌ All tested endpoints failed (likely all are Legacy)"
}
```
→ **対処**:
- FMP APIキーが有効か確認
- FMP APIのレート制限を確認（250リクエスト/日）
- https://financialmodelingprep.com/developer/docs でキーの状態を確認

### 7. スクリーニングAPIのテスト

#### テスト1: 基本的なスクリーニング

```bash
curl "https://[your-app].vercel.app/api/screener?marketCapUSDMin=1000000000"
```

- [ ] `"success": true` が返される
- [ ] `"count"` が0より大きい
- [ ] `results` 配列にデータが含まれる

#### テスト2: セクターフィルター

```bash
curl "https://[your-app].vercel.app/api/screener?sectors=Technology&epsGrowth3YMin=20"
```

- [ ] テクノロジー株のみが返される
- [ ] 各株に `score` が含まれる
- [ ] 結果がスコアの降順でソートされている

#### テスト3: プリセットフィルター

```bash
curl "https://[your-app].vercel.app/api/screener?preset=growth"
```

- [ ] 成長株が返される
- [ ] フィルター条件が適用されている

---

## 🌐 フロントエンドの確認

### 8. ホームページ

```
https://[your-app].vercel.app/
```

- [ ] ページが正常に表示される
- [ ] レイアウトが崩れていない
- [ ] リンクが正常に動作する

### 9. スクリーニングページ

```
https://[your-app].vercel.app/screener
```

- [ ] ページが表示される
- [ ] プリセットボタンが表示される
- [ ] スコア配点の表示がある

### 10. プリセットフィルターのテスト

各プリセットボタンをクリックして確認:

- [ ] **成長株** - 結果が表示される（0件でない）
- [ ] **割安株** - 結果が表示される
- [ ] **高配当株** - 結果が表示される
- [ ] **財務健全株** - 結果が表示される

### 11. フィルター条件の詳細表示

- [ ] 各カテゴリが展開できる（ファンダメンタル、バリュエーション等）
- [ ] フィルター入力欄が表示される
- [ ] カスタムフィルター条件が適用できる

### 12. 検索結果の表示

検索実行後:

- [ ] ローディング表示が出る
- [ ] 結果が表示される
- [ ] 各株式の情報が表示される:
  - [ ] シンボル（AAPL等）
  - [ ] 会社名
  - [ ] 価格
  - [ ] 時価総額
  - [ ] スコア（棒グラフ）
- [ ] スコアの内訳が表示される

---

## ⚡ パフォーマンス確認

### 13. レスポンス時間

- [ ] ホームページの読み込み: < 3秒
- [ ] スクリーニングページの読み込み: < 3秒
- [ ] API レスポンス（基本的な検索）: < 30秒
- [ ] API レスポンス（複雑な検索）: < 60秒

### 14. ブラウザコンソールのエラー

F12を押して開発者ツールを開き、Consoleタブを確認:

- [ ] エラーメッセージがない（赤い表示）
- [ ] 警告が重大でない（黄色い表示）
- [ ] ネットワークエラーがない

### 15. ネットワークタブの確認

開発者ツールのNetworkタブで:

- [ ] `/api/screener` のステータスコードが 200
- [ ] レスポンスサイズが妥当（通常 < 1MB）
- [ ] APIキーがネットワークタブに表示されない（セキュリティ）

---

## 🔒 セキュリティ確認

### 16. APIキーの保護

ブラウザの開発者ツールで確認:

- [ ] ページのソースに `FMP_API_KEY` が含まれていない
- [ ] JavaScriptファイルに `FMP_API_KEY` が含まれていない
- [ ] ネットワークリクエストに `apikey=` パラメータが表示されない

**確認方法**:
1. F12で開発者ツールを開く
2. Sources タブで JavaScript ファイルを検索
3. `FMP_API_KEY` で検索 → **見つからないこと**

### 17. HTTPS接続

- [ ] URLが `https://` で始まる（`http://` ではない）
- [ ] ブラウザのアドレスバーに鍵マークが表示される

---

## 📊 データの正確性

### 18. 株式データの検証

いくつかの有名株（AAPL、MSFT、GOOGL等）で確認:

- [ ] 価格が現在の市場価格に近い
- [ ] 時価総額が妥当
- [ ] セクター分類が正しい
- [ ] スコアが合理的

**確認方法**:
Yahoo Finance等で実際の価格と比較

### 19. フィルター条件の動作

- [ ] 時価総額フィルターが正しく機能する
- [ ] セクターフィルターが正しく機能する
- [ ] 複数フィルターの組み合わせが正しく機能する

---

## 🐛 エラーハンドリング

### 20. エラーケースのテスト

#### ケース1: 無効なパラメータ

```bash
curl "https://[your-app].vercel.app/api/screener?marketCapUSDMin=invalid"
```

- [ ] エラーが適切に処理される
- [ ] 500エラーにならない

#### ケース2: 結果が0件

```bash
curl "https://[your-app].vercel.app/api/screener?marketCapUSDMin=999999999999999"
```

- [ ] `"success": true` だが `"count": 0`
- [ ] `"results": []` が返される
- [ ] エラーメッセージが表示される

---

## 📈 モニタリング

### 21. ログの確認

**Vercelの場合**:
1. Dashboard → プロジェクト選択
2. Deployments → 最新デプロイをクリック
3. "View Function Logs" をクリック

- [ ] API呼び出しのログが記録されている
- [ ] エラーログがない（またはクリティカルでない）
- [ ] `[FMP]` プレフィックスのログが表示される

### 22. Analytics（オプション）

Vercel Analytics が有効な場合:

- [ ] ページビューが記録される
- [ ] APIコール数が記録される
- [ ] パフォーマンスメトリクスが表示される

---

## ✅ 最終確認

### 23. エンドツーエンドテスト

実際のユーザーフローをテスト:

1. [ ] ホームページにアクセス
2. [ ] スクリーニングページに移動
3. [ ] 「成長株」プリセットをクリック
4. [ ] 結果が表示される（10秒以内）
5. [ ] 結果の株式をクリックして詳細ページに移動
6. [ ] 詳細情報が表示される

### 24. モバイル対応

スマートフォンまたはブラウザのモバイルビュー（F12 → Device Toggle）で:

- [ ] レイアウトが正しく表示される
- [ ] ボタンがタップできる
- [ ] スクロールが正常
- [ ] 検索結果が読みやすい

### 25. クロスブラウザテスト

複数のブラウザで確認:

- [ ] Chrome
- [ ] Firefox
- [ ] Safari（Mac/iOS）
- [ ] Edge

---

## 📝 結果の記録

### デプロイ情報

- **デプロイ日時**: _______________
- **本番URL**: _______________
- **デプロイID**: _______________
- **ビルド時間**: _______________

### テスト結果サマリー

- **診断API**: ✅ / ❌
- **スクリーニングAPI**: ✅ / ❌
- **フロントエンド**: ✅ / ❌
- **パフォーマンス**: ✅ / ❌
- **セキュリティ**: ✅ / ❌

### 発見された問題

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 対処したアクション

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

---

## 🆘 トラブルシューティング

問題が発生した場合:

1. **[診断API] APIキー未設定**
   - Vercel/Netlifyで環境変数を確認
   - 再デプロイ

2. **[スクリーニングAPI] 結果が0件**
   - FMP APIのレート制限を確認（250/日）
   - フィルター条件を緩和してテスト

3. **[フロントエンド] ページが表示されない**
   - ビルドログを確認
   - ビルドエラーを解決して再デプロイ

4. **[パフォーマンス] 遅い**
   - キャッシング戦略を確認
   - FMP APIの詳細データ取得を無効化（`fetchDetailedData=false`）

5. **[セキュリティ] APIキーが見える**
   - 即座にAPIキーを無効化
   - 新しいキーを取得して再設定

---

## ✅ すべてクリア！

すべてのチェック項目が✅になったら、本番環境は正常に動作しています！

**次のステップ**:
- ユーザーに公開
- モニタリング継続
- フィードバック収集
- 機能改善

---

**確認者**: _______________
**確認日**: _______________
**署名**: _______________
