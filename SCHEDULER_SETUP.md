# ãƒªã‚¹ã‚¯ç›£è¦–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

æ¯æœ9æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•çš„ã«ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’å®Ÿè¡Œã—ã€Slack ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®è¨­å®šæ–¹æ³•ã§ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

```env
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã® Cron è¡¨è¨˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ¯æ—¥ 00:00 UTC (æ—¥æœ¬æ™‚é–“ 09:00)
# å½¢å¼: ç§’ åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥
CRON_SCHEDULE=0 0 0 * * *

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
TZ=Asia/Tokyo
```

### 2. Slack Webhook ã®ç¢ºèª

ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒSlacké€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š

```env
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
SLACK_ENABLED=true
```

## å‹•ä½œç¢ºèª

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
npm run dev

# ãƒ­ã‚°ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®åˆæœŸåŒ–ã‚’ç¢ºèª
# ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ï¼š
# ğŸš€ Initializing Risk Monitor Scheduler...
# âœ… Risk Monitor Scheduler initialized successfully
# ğŸ• Risk Monitor Scheduler started with cron: 0 0 0 * * *
```

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª

ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®APIã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```bash
# ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆï¼‰
curl http://localhost:3000/api/risk-monitor

# é€šçŸ¥å±¥æ­´ã‚’ç¢ºèª
curl http://localhost:3000/api/notifications/history
```

## Cron è¡¨è¨˜ã®èª¬æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§’ (0 - 59)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ† (0 - 59)
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ™‚ (0 - 23)
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥ (1 - 31)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆ (1 - 12)
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ›œæ—¥ (0 - 7) (0 ã¨ 7 ã¯æ—¥æ›œæ—¥)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
* * * * * *
```

### ã‚ˆãä½¿ã†è¨­å®š

| æ™‚é–“å¸¯ | Cronè¡¨è¨˜ | èª¬æ˜ |
|------|--------|------|
| **æ¯æ—¥ 09:00 (JST)** | `0 0 0 * * *` | UTC 00:00 = JST 09:00 |
| **æ¯æ—¥ 15:00 (JST)** | `0 0 6 * * *` | UTC 06:00 = JST 15:00 |
| **æ¯æ—¥ 18:00 (JST)** | `0 0 9 * * *` | UTC 09:00 = JST 18:00 |
| **å¹³æ—¥ 09:00 (JST)** | `0 0 0 * * 1-5` | æœˆã€œé‡‘ã®ã¿ |
| **åœŸæ›œ 09:00 (JST)** | `0 0 0 * * 6` | åœŸæ›œã®ã¿ |

## å®Ÿè£…è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
stock-analyzer-2025/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ scheduler.ts          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å®Ÿè£…
â”‚       â”œâ”€â”€ riskMonitor.ts        # ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
â”‚       â”œâ”€â”€ fredAPI.ts            # ãƒã‚¯ãƒ­çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚       â”œâ”€â”€ marketData.ts         # å¸‚å ´ãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚       â””â”€â”€ notifications.ts      # Slack/Discordé€šçŸ¥
â”œâ”€â”€ instrumentation.ts            # Next.js ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
â”œâ”€â”€ next.config.ts                # experimentalHookæœ‰åŠ¹åŒ–
â””â”€â”€ .env.local                    # ç’°å¢ƒå¤‰æ•°è¨­å®š
```

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®å‹•ä½œãƒ•ãƒ­ãƒ¼

```
â”Œâ”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
â”‚
â”œâ”€ instrumentation.tså®Ÿè¡Œ
â”‚  â””â”€ startRiskMonitorScheduler() å‘¼ã³å‡ºã—
â”‚
â”œâ”€ node-cronã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–‹å§‹
â”‚  â””â”€ æ¯æ—¥ 00:00 UTC ã«å®Ÿè¡Œ
â”‚
â”œâ”€ executeRiskAssessment() å®Ÿè¡Œ
â”‚  â”œâ”€ FRED API ã‹ã‚‰ãƒã‚¯ãƒ­ãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚  â”œâ”€ Yahoo Finance ã‹ã‚‰æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚  â”œâ”€ ãƒªã‚¹ã‚¯è©•ä¾¡è¨ˆç®—
â”‚  â””â”€ Slack ã«é€šçŸ¥é€ä¿¡
â”‚
â””â”€ ãƒ­ã‚°å‡ºåŠ›ï¼†å®Œäº†
```

### ãƒ­ã‚°å‡ºåŠ›ä¾‹

```
ğŸš€ Initializing Risk Monitor Scheduler...
âœ… Risk Monitor Scheduler initialized successfully
ğŸ• Risk Monitor Scheduler started with cron: 0 0 0 * * *

============================================================
ğŸ“Š Risk Assessment Execution - Trigger: Scheduled - 2026-01-17 09:00:00
============================================================

âœ“ Data fetched successfully

âœ“ Risk Assessment Calculated:
  Overall Score: 65.3/100
  Risk Level: ELEVATED

ğŸ“¤ Sending notifications...
  âœ“ Slack: Success
  âœ“ Discord: Failed

âœ… Execution completed in 2345ms
============================================================
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒèµ·å‹•ã—ãªã„å ´åˆ

1. **ãƒ­ã‚°ã‚’ç¢ºèª**
   ```bash
   npm run dev 2>&1 | grep -i scheduler
   ```

2. **instrumentation.ts ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**
   - ãƒ“ãƒ«ãƒ‰æ™‚ã«ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™
   ```
   instrumentationHook has been enabled
   ```

3. **next.config.ts ã‚’ç¢ºèª**
   ```typescript
   experimental: {
     instrumentationHook: true,
   }
   ```

### Slack é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„å ´åˆ

1. **Webhook URL ã‚’ç¢ºèª**
   ```bash
   echo $SLACK_WEBHOOK_URL
   ```

2. **ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã‚’ç¢ºèª**
   - ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ãŒ 60 æœªæº€ã®å ´åˆã€é€šçŸ¥ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“
   ```bash
   curl http://localhost:3000/api/risk-monitor | jq '.data.overallScore'
   ```

3. **ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª**
   ```bash
   npm run dev 2>&1 | grep -i "slack\|notification\|error"
   ```

## æœ¬ç•ªç’°å¢ƒã¸ã®å±•é–‹

### Vercel ã§ã®å®Ÿè¡Œ

Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€`instrumentation.ts` ãŒè‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒå‹•ä½œã—ã¾ã™ã€‚

1. **ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š**
   - Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ç’°å¢ƒå¤‰æ•°
   - ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
     ```
     SLACK_WEBHOOK_URL=...
     FRED_API_KEY=...
     CRON_SCHEDULE=0 0 0 * * *
     TZ=Asia/Tokyo
     ```

2. **ãƒ‡ãƒ—ãƒ­ã‚¤**
   ```bash
   git push
   ```

3. **å‹•ä½œç¢ºèª**
   - Vercel ãƒ­ã‚°ã§ scheduler ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
   - Slack ã§æœ9æ™‚ã«é€šçŸ¥ãŒæ¥ã‚‹ã‹ç¢ºèª

### AWS Lambda ã¨ã®çµ„ã¿åˆã‚ã›

å®šæœŸå®Ÿè¡Œã®ç¢ºå®Ÿæ€§ã‚’é«˜ã‚ã‚‹å ´åˆã€AWS Lambda + EventBridge ã®åˆ©ç”¨ã‚‚æ¤œè¨ã§ãã¾ã™ï¼š

```typescript
// Lambda ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
import { executeRiskAssessment } from "./app/utils/scheduler";

export async function handler(event: any) {
  return await executeRiskAssessment("Lambda");
}
```

EventBridge ãƒ«ãƒ¼ãƒ«ï¼š
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¼: `cron(0 0 * * ? *)` (æ¯æ—¥ 00:00 UTC)
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ä¸Šè¨˜ã® Lambda é–¢æ•°

## ä»Šå¾Œã®æ‹¡å¼µ

- [ ] ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
- [ ] ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥æ™‚é–“ã®è¨­å®š
- [ ] è¤‡æ•°ã®Slackãƒãƒ£ãƒãƒ«ã¸ã®é€šçŸ¥
- [ ] é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶ã®è¨­å®š
- [ ] é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

## å‚è€ƒè³‡æ–™

- [node-cron ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/kelektiv/node-cron)
- [Next.js Instrumentation](https://nextjs.org/docs/app/api-reference/file-conventions/instrumentation)
- [Cron å¼ã®èª¬æ˜](https://crontab.guru/)
