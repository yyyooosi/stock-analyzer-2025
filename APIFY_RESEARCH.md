# Apify を使った X (Twitter) データ取得の実現可能性調査

> **調査日**: 2026-02-16
> **対象プロジェクト**: stock-analyzer-2025
> **調査背景**: X API Free Tier の制限（月10回・15分に1回）を回避する代替手段として Apify を評価

---

## 目次

1. [現状の問題](#1-現状の問題)
2. [Apify とは](#2-apify-とは)
3. [利用可能な Actor（スクレイパー）](#3-利用可能な-actorスクレイパー)
4. [料金プランと無料枠の詳細](#4-料金プランと無料枠の詳細)
5. [技術的な実現可能性](#5-技術的な実現可能性)
6. [法的・ToS リスクの評価](#6-法的tos-リスクの評価)
7. [X API vs Apify 比較表](#7-x-api-vs-apify-比較表)
8. [このプロジェクトへの適合性](#8-このプロジェクトへの適合性)
9. [実装方針と設計](#9-実装方針と設計)
10. [コスト試算](#10-コスト試算)
11. [結論と推奨事項](#11-結論と推奨事項)
12. [セットアップ手順](#12-セットアップ手順)

---

## 1. 現状の問題

### X API Free Tier の制限

現在このプロジェクトは `TWITTER_BEARER_TOKEN` を使って公式 X API v2 を呼び出している。

| 制限項目 | Free Tier の制限値 |
|---------|-------------------|
| 月間リクエスト数 | **10回** |
| リクエスト間隔 | **15分に1回** |
| 取得件数/リクエスト | 最大 10件 |
| 対象データ | 直近 7日分のみ |
| $AAPL などのキャッシュタグ演算子 | **使用不可** |

**実運用上の問題点:**
- 月10回はほぼ即日で使い切る（株価分析ツールとして実用性ゼロ）
- 15分間隔の縛りにより、リアルタイム性が著しく低下
- キャッシュタグ演算子が使えないため検索精度が下がる
- 有料プランは月 $5,000〜 と非常に高額

---

## 2. Apify とは

Apify はクラウドベースのウェブスクレイピングプラットフォーム。
「Actor」と呼ばれる独立したスクレイピングプログラムを実行できるマーケットプレイスを提供している。

```
ユーザー (このアプリ)
    │
    ▼
Apify API (REST)
    │
    ▼
Tweet Scraper Actor (Apify のクラウドで実行)
    │  ← X.com のゲスト認証 or ログイン済みセッションを使う
    ▼
X.com の公開タイムライン・検索結果
    │
    ▼
構造化されたツイートデータ (JSON)
```

**特徴:**
- X の公式 API を経由せず、ブラウザと同じ経路でデータを取得
- IP ローテーション・セッションプーリングによりブロック回避
- REST API 1本で呼び出せるため既存コードへの統合が容易

---

## 3. 利用可能な Actor（スクレイパー）

### 主要な Twitter/X スクレイパー Actor

| Actor ID | 名称 | 特徴 | 料金 |
|----------|------|------|------|
| `apidojo/tweet-scraper` | Tweet Scraper V2 ⭐ | 最も安定・高機能 | $0.50 / 1,000 tweets |
| `apidojo/twitter-scraper-lite` | Twitter Scraper Unlimited | 制限なし・大量取得向け | 従量課金 |
| `kaitoeasyapi/twitter-x-data-tweet-scraper-pay-per-result-cheapest` | Cheapest Twitter Scraper | 最安値 | $0.25 / 1,000 tweets |
| `xtdata/twitter-x-scraper` | X.com Twitter API Scraper | 汎用 | 従量課金 |

### 推奨: `apidojo/tweet-scraper` (Tweet Scraper V2)

**選定理由:**
- Apify 公式推薦の安定 Actor
- 日本語ツイートの取得実績あり
- `searchTerms` に複数クエリを渡せる
- 取得速度: 数十件/秒
- 最小メモリ: 128MB（コスト効率が良い）

**入力パラメータ:**
```json
{
  "searchTerms": ["AAPL crash", "暴落 AAPL"],
  "maxItems": 20,
  "queryType": "Latest"
}
```

**出力データ (1ツイートあたり):**
```json
{
  "id": "1887654321098765432",
  "text": "AAPL が暴落している！今すぐ売れ",
  "fullText": "...",
  "createdAt": "Mon Feb 10 08:00:00 +0000 2026",
  "retweetCount": 42,
  "replyCount": 15,
  "likeCount": 120,
  "quoteCount": 8,
  "viewCount": 5000,
  "isRetweet": false,
  "lang": "ja",
  "author": {
    "id": "12345678",
    "userName": "investor_jp",
    "name": "投資家太郎",
    "isVerified": false
  }
}
```

---

## 4. 料金プランと無料枠の詳細

### Apify プラン一覧

| プラン | 月額 | 無料クレジット | メモリ上限 | データ保存期間 |
|--------|------|--------------|-----------|--------------|
| **Free** | $0 | $5/月 | 4 GB | 7日間 |
| Starter | $39 | 含む | 128 GB | 21日間 |
| Scale | $199 | 含む | 256 GB | 90日間 |
| Business | $999 | 含む | 256 GB | 180日間 |

### 無料枠でどれくらい取得できるか？

```
無料クレジット: $5/月
Tweet Scraper V2 の料金: $0.50 / 1,000 tweets

→ 月間取得可能ツイート数: 5 / 0.50 × 1,000 = 約 10,000 ツイート/月
```

**株価分析での使い方に当てはめると:**

| シナリオ | 必要ツイート数/日 | 月間合計 | 必要コスト |
|---------|----------------|---------|----------|
| 最小構成（1銘柄, 20件/リクエスト）| 20件 | 600件 | **無料枠内** |
| 通常運用（5銘柄, 20件/銘柄）| 100件 | 3,000件 | **無料枠内** |
| 本格運用（20銘柄, 50件/銘柄）| 1,000件 | 30,000件 | ~$15/月 |

---

## 5. 技術的な実現可能性

### ◎ 実現可能な点

#### 5-1. API の簡便性
```
X API (現状):
  GET https://api.twitter.com/2/tweets/search/recent
    Authorization: Bearer {token}
    → 月10回まで

Apify (代替):
  POST https://api.apify.com/v2/acts/apidojo~tweet-scraper/run-sync-get-dataset-items
    ?token={apify_token}
    body: { "searchTerms": ["query"], "maxItems": 20 }
    → 実質制限なし（クレジット次第）
```

既存の `app/api/twitter/search/route.ts` を数行変更するだけで統合可能。

#### 5-2. 取得可能なデータ
- ✅ ツイート本文（日英両対応）
- ✅ タイムスタンプ
- ✅ エンゲージメント数（いいね・RT・返信・引用）
- ✅ ユーザー情報（ハンドル・表示名・認証バッジ）
- ✅ 言語情報（`lang` フィールド）
- ✅ 表示回数 (`viewCount`) ← X API では有料プランのみ
- ✅ 検索クエリ（X の検索構文がそのまま使える）

#### 5-3. 同期実行 API
`run-sync-get-dataset-items` エンドポイントを使えば、1回の HTTP リクエストで結果まで取得できる。ポーリング不要で既存設計に馴染む。

### △ 懸念点・制限事項

#### 5-4. 応答時間
- Actor の起動（コールドスタート）: 10〜30秒
- データ取得・処理: クエリとデータ量次第
- **合計: 20〜60秒程度**（公式 X API の 1〜3 秒より遅い）

→ 対策: ローディング UI の強化、事前キャッシュ

#### 5-5. ゲスト認証の限界
- ログインなしのゲスト認証では **1ユーザーのタイムラインから約100件** まで
- 検索クエリでは数千〜数万件取得可能（問題なし）

#### 5-6. X.com 側の変更リスク
- X が HTML 構造や API エンドポイントを変更するとスクレイパーが壊れる可能性
- ただし Apify の Actor メンテナーが定期的に更新しているため、短期間の停止で回復

#### 5-7. 安定性
- Apify のインフラ障害時に影響を受ける（単一障害点）
- → 既存のデモデータフォールバックで継続動作は保証済み

---

## 6. 法的・ToS リスクの評価

### X の Terms of Service について

```
X Developer Agreement より:
"You may not scrape Twitter content or access Twitter content
 through means other than the Twitter API."
```

**リスク評価: 中程度**

| リスク項目 | 評価 | 詳細 |
|-----------|------|------|
| ToS 違反 | ⚠️ 中 | X の ToS はスクレイピングを明示的に禁止 |
| 法的合法性 | ✅ 低リスク | 米国第9巡回区裁判所 (2022) が公開データのスクレイピングは合法と判決 |
| アカウント BAN | ⚠️ 中 | Apify は IP ローテーションで対策しているが、ゼロではない |
| 日本法での扱い | ✅ 低リスク | 公開情報の取得は不正アクセス禁止法の対象外 |

### 軽減策
1. **公開データのみを対象** にする（ログイン不要な投稿のみ）
2. **過剰な取得を避ける**（1リクエスト 20〜50 件程度）
3. **Apify の規約に準拠**（Apify 自体は利用規約でスクレイピングを許可している）
4. **将来的には有料 X API への移行を検討**（ビジネス規模に応じて）

---

## 7. X API vs Apify 比較表

| 比較項目 | X API Free Tier | Apify (Free Tier) | Apify (有料) |
|---------|-----------------|-------------------|-------------|
| **月間取得可能件数** | 100件 (10回×10件) | **~10,000件** | 無制限 |
| **リクエスト間隔** | 15分に1回 | **制限なし** | 制限なし |
| **応答時間** | 1〜3秒 | 20〜60秒 | 10〜30秒 |
| **日本語対応** | ✅ | ✅ | ✅ |
| **キャッシュタグ ($AAPL)** | ❌ (Free Tier 不可) | ✅ | ✅ |
| **履歴データ** | 直近7日のみ | 深い履歴あり | 深い履歴あり |
| **ビュー数** | ❌ (有料のみ) | ✅ | ✅ |
| **承認プロセス** | 数週間 | **即日** | 即日 |
| **コスト** | $0 | $0 (〜10,000件) | $0.25〜0.50/1K |
| **ToS 準拠** | ✅ 完全準拠 | ⚠️ グレーゾーン | ⚠️ グレーゾーン |
| **安定性** | ✅ 高い | △ X の変更に依存 | △ X の変更に依存 |

---

## 8. このプロジェクトへの適合性

### 株価分析ツールとしての要件マッチング

| 要件 | X API Free | Apify | 評価 |
|------|-----------|-------|------|
| 銘柄ごとのクラッシュ感情分析 | ❌ 月10回 | ✅ 無制限 | **Apify 優位** |
| 日英ツイートの混合検索 | △ 制限あり | ✅ 対応 | **Apify 優位** |
| 複数銘柄の並行監視 | ❌ 即上限超過 | ✅ 可能 | **Apify 優位** |
| リアルタイム性 (秒単位) | ✅ 速い | ❌ 遅い (20〜60s) | **X API 優位** |
| 低コスト運用 | ✅ 無料 | ✅ 無料 (〜10K件) | **同等** |
| 既存コードへの統合 | N/A | ✅ 少変更で対応 | **Apify 優位** |

**結論: 株価クラッシュ分析ツールとして Apify は十分実用的。**
リアルタイム性より取得量・可用性が重要なユースケースのため、Apify が優位。

---

## 9. 実装方針と設計

### フォールバック チェーン

```
リクエスト受信
    │
    ▼
TWITTER_BEARER_TOKEN は設定されているか？
    │ YES                      │ NO
    ▼                          │
X API v2 を呼び出す            │
    │                          │
    ├─ 200 OK → 結果を返す     │
    │                          │
    ├─ 429 / 403 (レート制限)  │
    │   → Apify にフォールバック│
    │                          ▼
    └─ その他エラー     APIFY_API_TOKEN は設定されているか？
        → エラー返却      │ YES                   │ NO
                          ▼                       ▼
                     Apify Actor を実行       500 エラー
                          │
                          ├─ 成功 → 結果を返す (_source: 'apify')
                          │
                          └─ 失敗 → 502 エラー
                              (フロント側でデモデータにフォールバック)
```

### 実装ファイル構成

```
app/
├── utils/
│   ├── twitterAPI.ts        # 既存: クライアント側ユーティリティ（変更なし）
│   └── apifyTwitter.ts      # NEW: Apify 統合ユーティリティ
└── api/
    └── twitter/
        └── search/
            └── route.ts     # 更新: Apify フォールバック追加
```

### レスポンスフォーマット互換性

Apify の結果は X API 互換フォーマットに変換して返す。
フロントエンド (`twitterAPI.ts`) の改修は**不要**。

```typescript
// Apify レスポンス → X API 互換フォーマット
{
  data: [{ id, text, author_id, created_at, public_metrics }],
  includes: { users: [{ id, username }] },
  meta: { result_count, newest_id, oldest_id },
  _source: 'apify'  // デバッグ用: どのソースから取得したかを示す
}
```

---

## 10. コスト試算

### 想定利用パターン（月間）

```
シナリオ: 1日5回、5銘柄分の検索、各20件

月間ツイート取得数: 5回 × 5銘柄 × 20件 × 30日 = 15,000件

コスト計算:
  Tweet Scraper V2: $0.50 / 1,000 件
  15,000件 × $0.50 / 1,000 = $7.50/月

無料枠 ($5/月) を超える分: $2.50/月
```

**月 $2.50〜$7.50 で X API Free Tier の 150倍以上の取得能力を得られる。**

---

## 11. 結論と推奨事項

### ✅ 実現可能性: **高い**

Apify を使った X ツイート取得は技術的・コスト的に十分実現可能。

### 推奨アクション

| 優先度 | アクション | 理由 |
|--------|-----------|------|
| 🔴 必須 | `APIFY_API_TOKEN` を環境変数に設定 | 即日利用開始できる |
| 🔴 必須 | フォールバック動作を本番環境で検証 | 安定性確認 |
| 🟡 推奨 | レスポンスキャッシュの実装 (5〜15分) | Apify の遅延を補完 |
| 🟡 推奨 | `_source` フィールドをログに記録 | どちらのデータかモニタリング |
| 🟢 任意 | X API Basic Tier ($100/月) への将来移行検討 | ToS リスクを排除したい場合 |

### 非推奨な選択肢

- ❌ **X API Basic Tier への即時移行**: $100/月 は初期コストとして高すぎる
- ❌ **現状の Free Tier のみ継続**: 月10回制限では分析ツールとして機能しない
- ❌ **独自スクレイパーの実装**: 開発・維持コストが高く、Apify の方が効率的

---

## 12. セットアップ手順

### Step 1: Apify アカウント作成

1. https://console.apify.com/sign-up でアカウント作成
2. 無料プランは $5/月のクレジットが自動付与される
3. クレジットカード不要で即日利用開始可能

### Step 2: API トークン取得

1. https://console.apify.com/account/integrations にアクセス
2. 「Personal API tokens」→「Create new token」
3. トークンをコピー

### Step 3: 環境変数の設定

```bash
# .env.local に追加
APIFY_API_TOKEN=apify_api_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### Step 4: 動作確認

```bash
# Apify 接続確認用エンドポイントを呼び出す
curl http://localhost:3000/api/twitter/search?query=AAPL%20crash&max_results=10
```

レスポンスに `"_source": "apify"` が含まれていれば Apify 経由で動作している。

### Step 5: 本番環境 (Vercel) への適用

```bash
vercel env add APIFY_API_TOKEN
# または Vercel ダッシュボード → Settings → Environment Variables で追加
```

---

*調査完了: 2026-02-16 | 実装ブランチ: `claude/apify-x-api-research-HVCLY`*
